function _override(a,b,c){var d=a._superClass;a.prototype[b]=function(a,b){return function(){var a=this._super;this._super=d;var c=b.apply(this,arguments);return this._super=a,c}}(b,c)}function _extends(a,b,c){if(a.prototype=new b,a.prototype.constructor=a,a._superClass=new b,null!=c)for(var d in c)"function"==typeof c[d]&&"function"==typeof a._superClass[d]?_override(a,d,c[d]):a.prototype[d]=c[d]}function IframeMicroworld(a,b){this.config=jQuery.extend({},IframeMicroworld.DEFAULT_CONFIG,a||{}),this.options=jQuery.extend({},IframeMicroworld.DEFAULT_OPTIONS,b||{}),this.microworldIframe=null,this.url=null,this.status=IframeMicroworld.LOADING,this.isActive=!0,this.firstLoad=!0,this.hasBeenClosed=!1,this.reconstructionData="",this.mwSettings={chat:[],mw:[]},this.readyMessages=[],this._create()}function ImageMicroworld(a,b){this.config=jQuery.extend({},IframeMicroworld.DEFAULT_CONFIG,a||{}),this.options=jQuery.extend({},IframeMicroworld.DEFAULT_OPTIONS,b||{}),this.image=null,this.url=null,this.status=IframeMicroworld.READY,this.isActive=!0,this.firstLoad=!0,this.hasBeenClosed=!1,this.reconstructionData="",this.mwSettings={chat:[],mw:[]},this._create()}function MediaMicroworld(a,b){this.config=jQuery.extend({},IframeMicroworld.DEFAULT_CONFIG,a||{}),this.options=jQuery.extend({},IframeMicroworld.DEFAULT_OPTIONS,b||{}),this.media=null,this.url=null,this.status=IframeMicroworld.LOADING,this.isActive=!0,this.firstLoad=!0,this.hasBeenClosed=!1,this.actions={},this.reconstructionData="",this.mwSettings={chat:[],mw:[]},this._create()}function Question(a,b){this.options=jQuery.extend({},b||{}),this.id=a.id,this.config=a,this.intervention=null,this.currentAnswerIndex=-1,this.currentAnswer=null,this.numAnswer=0,this.givenAnswersWeight=0,this.givenAnswers=[],this.lemmas=[],this.status=Question.WAITING_ANSWER,this.init()}function Intervention(a,b){this.config=a,this.type=b,this.text="",this.microworld={display:[],hide:[],set:[]},this.emotion="",this.options=[],this.segments=[],this.init()}function Dialog(a,b){this.config=a||{},this.options=jQuery.extend({},Dialog.DEFAULT_OPTIONS,b||{}),this.currentQuestion=null,this.questionMap={},this.microworldMap={},this.dialogManager=null,this.microworldHolder={},this.questionHolder={},this.interventions=[],this.answerText="",this.currNumSwearword=-1,this.nrQuestionNeeded=0,this.currentLemmas={},this.treeNode=null,this.keysAnalysis={},this.hooks={},this.rebuilding=!1,this.huboNeg=!1,this.huboNegado=!1,this.arrPosNeg=[],this.matchedLemmas=[]}function AvatarDialogUI(a){this.options=jQuery.extend({},AvatarDialogUI.DEFAULT_OPTIONS,a||{}),this.chatContainer,this.microworldContainer,this.microworldContainerFront,this.microworldContainerVisited,this.microworldPopup,this.dialogContainer,this.dialogManager=null,this.canReadUserIntervention=!1,this.interventionDecorators={},this.interventionCount=0,this.hiddenParagraphs=0,this.fromTop=0,this.answerText="",this.multipleChoice=!1,this.sound=null,this.inputDisabled=!1,this.eraseInput=!0,this.rebuilding=!1,this.termsGlossed={},this.lastMw=null}function AvatarDialogUITextarea(a,b){AvatarDialogUI.apply(this,arguments)}function DialogManager(a,b,c){this.options=jQuery.extend({},DialogManager.DEFAULT_OPTIONS,c||{}),this.ui=b,this.dialog=a,this.ling,this.dialog.dialogManager=this,this.ui.dialogManager=this,this.windowActions={},this.availableFeatures={}}function getLemasJS(a,b){a=a.replace(/(\s)+/g," ");var c=a.split(/[.,;:¿?!¡]+/);for(j=0;j<conectores.length;j++)for(i=0;i<c.length;i++){var d=new RegExp(conectores[j],"i"),e=d.exec(c[i]);if(e){var f=c[i].substr(0,e.index),g=c[i].substr(e.index);c.splice(i,1,f,g),i++}}for(var h=/[\w\dáéíóúüñÁÉÍÓÚÜÑ\-\+]/,i=c.length-1;i>=0;i--)h.test(c[i])||c.splice(i,1);var k=separarPalsFrase(c),l=buscarLemas(k,b);return l}function separarPalsFrase(a){for(var b=new Array,c=0;c<a.length;c++){var d=a[c].match(/[\w\dáéíóúüñÁÉÍÓÚÜÑ\+\-]+/g);b.push(d)}return b}function buscarLemas(a,b){for(var c=[],d=0;d<a.length;d++){for(var e=[],f=0;f<a[d].length;f++){var g=a[d][f];if(""!=g){g=strToLc(g);var h=firstRound(g,b);isEmpty(h)?(h=getCorrJS(g),h[g]=[""]):h[g]=[g],e.push(h)}}c.push(e)}return c}function firstRound(a,b){var c;return c=b?addAcentos([a]):[a],getAllLemas(c)}function consultarJSON(a){var b={};for(var c in jsonMorf)if(!/^\!/.test(a)||!/\:/.test(c)){var d=jsonMorf[c],e=a.replace(/^\!/,"");-1!=d.indexOf(e)&&(b[c]=[e])}var f=/([íi]sim|[ée]rrim)[oa]s?$/,g=/mente$/,h=/(la|las|le|les|lo|los|me|nos|os|se|te|mela|melas|mele|meles|melo|melos|nosla|noslas|nosle|nosles|noslo|noslos|osla|oslas|osle|osles|oslo|oslos|osme|osnos|sela|selas|sele|seles|selo|selos|seme|senos|seos|sete|tela|telas|tele|teles|telo|telos|teme|tenos)$/;if(f.test(a)){a=a.replace(/isim/,"ísim"),a=a.replace(/errim/,"érrim");for(var c in jsonSuper)if(!/^\!/.test(a)||!/\:/.test(c)){var d=jsonSuper[c];-1!=d.indexOf(a.replace(/^\!/,""))&&(b[c]=[a])}}else if(g.test(a)){for(var c in jsonAdverb)if(!/^\!/.test(a)||!/\:/.test(c)){var d=jsonAdverb[c];-1!=d.indexOf(a.replace(/^\!/,""))&&(b[c]=[a])}}else if(h.test(a))for(var c in jsonEnclit){var d=jsonEnclit[c];-1!=d.indexOf(a)&&(b[c]=[a])}return b}function getCorrJS(a){var b;return b=a.length<=4||a.length>12?erroresFrecuentes(a):hacerOperaciones(a),getAllLemas(b)}function getAllLemas(a){for(var b={},c=0;c<a.length;c++){var d=a[c],e=consultarJSON(d);if(!isEmpty(e))for(var f in e)null==b[f]?b[f]=e[f]:b[f]=b[f].concat(e[f])}return b}function hacerOperaciones(a){var b=sustituirLetras(a);return b=b.concat(agregarLetras(a)),b=b.concat(eliminarLetras(a)),b=b.concat(invertirLetras(a)),b=b.concat(erroresFrecuentes(a)),b=addAcentos(b),b=noDuplicates(b)}function sustituirLetras(a){for(var b=new Array,c=0;c<a.length;c++){var d=a.charAt(c);if(nearKeysArr[d])for(var e=nearKeysArr[d].split(""),f=0;f<e.length;f++){var g=a.replaceAt(c,e[f]);c>=a.length-1&&!soloAcento(a.charAt(c),e[f])&&(g="!"+g),b.push(g)}}return b}function soloAcento(a,b){for(var c=[/[aá]/,/[eé]/,/[ií]/,/[oó]/,/[uú]/,/[uü]/],d=!1,e=0;e<c.length;e++){var f=c[e];if(f.test(a)&&f.test(b)){d=!0;break}}return d}function agregarLetras(a){for(var b=new Array,c=0;c<=a.length;c++)for(var d=0;d<abc.length;d++){var e=a.insertAt(c,abc[d]);c==a.length&&(e="!"+e),b.push(e)}return b}function eliminarLetras(a){for(var b=new Array,c=0;c<a.length;c++){var d=a.deleteAt(c,1);c==a.length-1&&(d="!"+d),b.push(d)}return b}function invertirLetras(a){for(var b=new Array,c=0;c<a.length-1;c++){var d=a.invertirChars(c,c+1);b.push(d)}return b}function addAcentos(a){for(var b,c=new Array,d=new Array("a","á","e","é","i","í","o","ó","u","u","ú","ú","ü","ü"),e=new Array("á","a","é","e","í","i","ó","o","ú","ü","u","ü","ú","u"),f=0;f<a.length;f++){var g=a[f];c.push(g);for(var h=0;h<g.length;h++)for(var i=0;i<d.length;i++)g.charAt(h)==d[i]&&(b=g.replaceAt(h,e[i]),c.push(b))}return c}function erroresFrecuentes(a,b){obj=[];for(var c=0;c<a.length;c++)obj[c]=new Array(a.charAt(c));for(var d=b?b:regexArr.length,e=0;d>e;e++)for(var f=regexArr[e].regex,g=regexArr[e].opciones,h=regexArr[e].lDerecha;f.test(a);)if(regexArr[e].doble)for(var i=0;i<g.length;i++)obj[f.lastIndex-h-2].push(g[i].charAt(0)),obj[f.lastIndex-h-2]=noDuplicates(obj[f.lastIndex-h-2]),g[i].length>1?obj[f.lastIndex-h-1].push(g[i].charAt(1)):obj[f.lastIndex-h-1].push(""),obj[f.lastIndex-h-1]=noDuplicates(obj[f.lastIndex-h-1]);else obj[f.lastIndex-h-1]=noDuplicates(obj[f.lastIndex-h-1].concat(g));var j,k;for(c=0;c<obj.length;c++)if(0==c)j=obj[c];else{k=[];for(var l=0;l<obj[c].length;l++)for(var m=0;m<j.length;m++)k.push(j[m]+obj[c][l]);j=k}for(k=[],c=0;c<j.length;c++){var n=j[c].match(/([áéíóú])/g);n&&1!=n.length||k.push(j[c])}return k}function makeString(a){for(var b="",c=0;c<a.length;c++){for(var d=a[c],e="",f=0;f<d.length;f++){var g=d[f],h="";for(var i in g){var j=g[i],k=i+"->"+j.join(",");""!=h&&(h+="/"),h+=k}""!=e&&(e+="//"),e+=h}""!=b&&(b+="///"),b+=e}return b}function isEmpty(a){var b=!0;for(var c in a){b=!1;break}return b}function strToLc(a){return a=a.toLowerCase(),a=a.replace(/Á/g,"á"),a=a.replace(/É/g,"é"),a=a.replace(/Í/g,"í"),a=a.replace(/Ó/g,"ó"),a=a.replace(/Ú/g,"ú"),a=a.replace(/Ü/g,"ü"),a=a.replace(/Ñ/g,"ñ")}function inArray(a,b){for(var c=!1,d=0;d<b.length;d++)if(b[d]==a){c=!0;break}return c}function noDuplicates(a){for(var b=[],c=0;c<a.length;c++)inArray(a[c],b)||b.push(a[c]);return b}function crearArbol(a){var b,c;a=traducirOps(a),a=agregarNeg(a);var d=getTokens(a),e=parsear(d);return b=e[0],c=e[1],0==c?b[0]:(console.log("ERROR"+c+"en clave "+a),null)}function agregarNeg(a){for(var b=a,c=/[^&\/\!\#\+\-\>_\)\(]+/g,d=0;match=c.exec(a);){var e=match[0];if(/[\*]/.test(e)){var f=e.length;e=e.replace(/[\*]/g,""),e="(("+e+")//(#("+e+")))",b=b.substr(0,match.index+d)+e+b.substr(match.index+d+f),d+=e.length-f}}return b}function traducirOps(a){var b=new Array(/AND/g,/OR/g,/NOT/g,/NEG/g,/MAS/g,/CAU/g,/SEG/g),c=new Array("&&","//","!","#","++","->","&+");return a=a.replaceArray(b,c)}function getTokens(a){for(var b=new Array,c=/[&\/\!\#\+\-\>_]/,d=/(\+\+|&&|\/\/|&\+|\!|\#|\-\>|_)/,e="",f="",g=0;g<a.length;g++)c.test(a.charAt(g))?(""!=e&&(b.push(e),e=""),f+=a.charAt(g),d.test(f)&&(b.push(f),f="")):"("==a.charAt(g)?b.push("("):")"==a.charAt(g)?(""!=e&&(b.push(e),e=""),b.push(")")):e+=a.charAt(g);return b}function parsear(a){for(var b,c=0,d=1,e=2,f=3,g=new Array,h=new Array,i=0,j=0,k=0;k<a.length;k++){var l=a[k],m=new Nodo_arbol;if(m.setToken(l),m.type==c)h.push(m),j++;else if(m.type==e)h.push(m);else if(m.type==f){var n=/^(SÍ|NO|DUDA)$/;if(n.test(m.token)){var o=crearArbolFijo(m.token);m=o[0]}g.push(m)}else if(m.type==d)if(j>0){if(b=crearNodo(g,h),g=b[0],h=b[1],i=b[2],h[h.length-1].type==c?(h.pop(),j--):i=3,h.length>0){var p=h[h.length-1];p.type==e&&p.valor<2&&(b=crearSimpleNode(g,h),g=b[0],h=b[1],i=b[2])}}else i=1}if(j>0&&(i=2),0==i&&h.length>0){var b=toOneNode(g,h);g=b[0],h=b[1],i=b[2]}return new Array(g,i)}function crearNodo(a,b){for(var c=0,d=2,e=0,f=new Array;b.length>0&&b[b.length-1].type==d;)f.push(b.pop());if(0==f.length);else if(1==f.length){var g=f[0];g.valor>=2&&a.length>=2?(g.addChild(a.pop()),g.addChild(a.pop()),a.push(g)):b[b.length-1].type==c?a.push(g):e=4}else{for(var h=!0,i=1;i<f.length;i++)if(f[i].token!=f[i-1].token){h=!1,e=6;break}if(h)if(g=f[0],a.length>f.length){for(var j=0;j<=f.length;j++)g.addChild(a.pop());a.push(g)}else e=5}return new Array(a,b,e)}function crearSimpleNode(a,b){var c=0,d=b.pop();return a.length>=1?(d.addChild(a.pop()),a.push(d)):c=7,new Array(a,b,c)}function toOneNode(a,b){var c,d=2,e=0;if(b[b.length-1].type==d){if(b[b.length-1].valor<2){var c=crearSimpleNode(a,b);a=c[0],b=c[1],e=c[2]}else c=crearNodo(a,b),a=c[0],b=c[1],e=c[2];b.length>0&&(c=toOneNode(a,b),a=c[0],b=c[1],e=c[2])}else e=8;return new Array(a,b,e)}function crearArbolFijo(a){var b=new Array("sí","síí","sííí","sii","siii","siiii","siiiii","síi","síii","sip","sipi","simón","ajá","ok","oké","okay","claro","seguro","por_supuesto","venir:venga","salir:sale","valer:vale","cierto","obvio","evidente","de_acuerdo","así_es","afirmativo","en_efecto","efectivo"),c=new Array("duda:NCFS,dudar:V...1;V.SP2S"),d=new Array("no","nop","nope","nopal","nel","nada","nunca","jamás","nadie","en_absoluto","ningún","ninguno","negativo:negativo"),e=new Array("modo,manera"),f=new Array("quién_saber:V...3S","quizá","quizás","a_lo_mejor","tal_vez","poder:V...3S_ser","ve_tú_a_saber","yo_qué_sé"),g=new Array("saber:V...1,entender:V...1;V.G,comprender:V...1;V.G,captar:V...1;V.G,claro,idea,seguro"),h=new Array;if("DUDA"==a){var i=crearNodoFijo(f,g);h.push(i)}else if("NO"==a){var j=crearNodoFijo(d,e),k=crearNodoFijo(f,g),l=new Nodo_arbol;l.setToken("!"),l.addChild(k);var i=new Nodo_arbol;i.setToken("&&"),i.addChild(l),i.addChild(j),h.push(i)}else if("SÍ"==a){var m=crearNodoFijo(b,c),j=crearNodoFijo(d,e),l=new Nodo_arbol;l.setToken("!"),l.addChild(j);var i=new Nodo_arbol;i.setToken("&&"),i.addChild(l),i.addChild(m),h.push(i)}return h}function crearNodoFijo(a,b){var c=new Nodo_arbol;c.setToken("//");for(var d=0;d<a.length;d++){var e=new Nodo_arbol,f=a[d].split("_");if(1==f.length)e.setToken(a[d]);else{e.setToken("_");for(var g=f.length-1;g>=0;g--){var h=new Nodo_arbol;h.setToken(f[g]),e.addChild(h)}}c.addChild(e)}var i=new Nodo_arbol;i.setToken("#");var h=new Nodo_arbol;return h.setToken(b[0]),i.addChild(h),c.addChild(i),c}function Nodo_arbol(){this.token,this.type,this.valor,this.children=[],this.lp=0,this.rp=1,this.op=2,this.pal=3,this.arrLemas=[],this.match,this.datosPos=[],this.datosPosTmp=[],this.lemasMatched=[],this.esNeg=!1,this.neg=!1}String.prototype.capitalizeFirstLetters=function(){for(var a=this.split(/\s+/),b="",c=0;c<a.length;c++)b+=a[c].charAt(0).toUpperCase()+a[c].slice(1),c<a.length-1&&(b+=" ");return b},String.prototype.strToLc=function(){var a=this;return a=a.toLowerCase(),a=a.replaceArray([/Á/g,/É/g,/Í/g,/Ó/g,/Ú/g,/Ü/g,/Ñ/g],["á","é","í","ó","ú","ü","ñ"])},String.prototype.replaceArray=function(a,b){for(var c=this,d=0;d<a.length;d++)c=c.replace(a[d],b[d]);return c},String.prototype.replaceAt=function(a,b){return this.substr(0,a)+b+this.substr(a+b.length)},String.prototype.insertAt=function(a,b){return this.substr(0,a)+b+this.substr(a)},String.prototype.deleteAt=function(a,b){return this.substr(0,a)+this.substr(a+b)},String.prototype.invertChars=function(a,b){return this.substr(0,a)+this.substr(b,1)+this.substr(a,1)+this.substr(b+1)},Array.prototype.injectArray=function(a,b){return this.slice(0,a).concat(b).concat(this.slice(a))};var MicroworldFactory={constructors:{},create:function(a,b,c){var d=MicroworldFactory.constructors[a];if(null!=d){var e=new MicroworldFactory.constructors[a](b,c);return e}return console.log("Constructor : "+a+"Not found in MicroworldFactory.factories"),null}};IframeMicroworld.DEFAULT_CONFIG={id:"",url:"",type:"iframe",w:null,h:null,x:null,y:null,front:!1,autoDisplay:!1,showLink:!0,textLink:"",deactivateChat:!1,toNextQuestionOnClose:!1,reset:!1},IframeMicroworld.DEFAULT_OPTIONS={defaultFolder:"micromundos/"},IframeMicroworld.LOADING="loading",IframeMicroworld.READY="ready",IframeMicroworld.prototype={_create:function(){var a=this.options.defaultFolder+this.config.url+"?version="+Math.random();this.microworldIframe=jQuery("<iframe></iframe>"),this.microworldIframe.attr({id:"microworld_"+this.config.id,"class":"microworld",src:a,"data-id":this.config.id}),this.url=a,this.microworldIframe.css({position:"absolute",width:this.config.w,height:this.config.h})},load:function(a){this.firstLoad=!1;var b=this.options.microworldContainer;return null!=a&&(b=jQuery(a)),null==b?void console.log("Property microworldContainer not defined in {options}"):(this.setXY(a),void b.append(this.microworldIframe))},setContainer:function(a){null!=a&&(this.options.microworldContainer=jQuery(a))},init:function(){console.log("Microworld.init")},setXY:function(a){this.microworldIframe.css("left",this.config.x?this.config.x:(a.width()-this.config.w)/2),this.microworldIframe.css("top",this.config.y?this.config.y:(a.height()-this.config.h)/2)},sendMessage:function(a){this.mwSettings.chat.push(a.name+":"+a.value),this.microworldIframe.get(0).contentWindow.postMessage(a,"*")},remove:function(){this.microworldIframe.remove(),this.firstLoad=!0,console.log("Microworld.remove "+this.id)},hide:function(){this.microworldIframe.addClass("isMwHidden")},show:function(){this.microworldIframe.removeClass("isMwHidden")}},MicroworldFactory.constructors.iframe=IframeMicroworld,ImageMicroworld.prototype={_create:function(){var a=this.options.defaultFolder+this.config.url;this.image=jQuery("<img />"),this.image.attr({id:"microworld_"+this.config.id,"class":"microworld",src:a,"data-id":this.config.id}),this.url=a,this.image.css({"max-width":"100%",position:"absolute",width:this.config.w,height:this.config.h})},load:function(a){this.firstLoad=!1;var b=this.options.microworldContainer;return null!=a&&(b=jQuery(a)),null==b?void console.log("Property microworldContainer not defined in {options}"):(this.setXY(a),void b.append(this.image))},setContainer:function(a){null!=a&&(this.options.microworldContainer=jQuery(a))},init:function(){console.log("Microworld.init")},setXY:function(a){this.image.css("left",this.config.x?this.config.x:(a.width()-this.config.w)/2),this.image.css("top",this.config.y?this.config.y:(a.height()-this.config.h)/2)},sendMessage:function(a){this.mwSettings.chat.push(a.name+":"+a.value)},remove:function(){this.image.remove(),this.firstLoad=!0},hide:function(){this.image.addClass("isMwHidden")},show:function(){this.image.removeClass("isMwHidden")}},MicroworldFactory.constructors.image=ImageMicroworld,MediaMicroworld.prototype={_create:function(){var a=this,b=this.options.defaultFolder+this.config.url,c="<video />";b.indexOf(".mp3")>0&&(c="<audio />"),this.media=jQuery(c),this.media.attr({id:"microworld_"+this.config.id,"class":"microworld",src:b,"data-id":this.config.id,controls:"controls"}),this.url=b;var d=jQuery("<source />");d.attr({src:b}),this.media.on("loadedmetadata",function(){$(this).data("loaded")===!0&&(a.status=IframeMicroworld.READY)}),this._init(),this.media.get(0).load(),this.media.append(d),this.media.css({"max-width":"100%",position:"absolute",width:this.config.w,height:this.config.h})},load:function(a){this.firstLoad=!1;var b=this.options.microworldContainer;return null!=a&&(b=jQuery(a)),null==b?void console.log("Property microworldContainer not defined in {options}"):(this.setXY(a),b.append(this.media),void console.log("Microworld.loaded"))},_init:function(){this.actions={play:function(a){console.log("play"),a.play()},pause:function(a){console.log("pause"),a.pause()},replay:function(a){console.log("replay"),a.currentTime=0,a.play()},"goto":function(a,b){console.log("goto: "+b.time),a.currentTime=b.time,a.play()}}},setContainer:function(a){null!=a&&(this.options.microworldContainer=jQuery(a))},init:function(){console.log("Microworld.init")},setXY:function(a){this.media.css("left",this.config.x?this.config.x:(a.width()-this.config.w)/2),this.media.css("top",this.config.y?this.config.y:(a.height()-this.config.h)/2)},sendMessage:function(a){this.mwSettings.chat.push(a.name+":"+a.value);var b=this.actions[a.command];if(null!=b){var c=[this.media.get(0)];null!=a.params&&c.push(a.params),b.apply(b,c)}},remove:function(){this.media.remove(),this.firstLoad=!0,console.log("Microworld.remove")},hide:function(){this.media.addClass("isMwHidden")},show:function(){this.media.removeClass("isMwHidden")}},MicroworldFactory.constructors.audio=MediaMicroworld,MicroworldFactory.constructors.video=MediaMicroworld,Question.DEFAULT_OPTIONS={audio:"",showBestAnswers:!1,display:"",nrRequiredResponses:1,prompt:"",delay:0,endDialogue:!1,shortKey:"(listo)",RADialKey:"(listo)",DescartesKey:"",regexKey:"",weight:1,description:"Respuesta correcta"},Question.READY="ready",Question.WAITING_ANSWER="waiting",Question.STANDBY="standby",Question.DONE="done",Question.prototype={init:function(){var a=Intervention.QUESTION;if(this.config.showBestAnswers){a=this.config.analyseAll?Intervention.MULTIPLE_CHOICE_MULT_CORRECT:Intervention.MULTIPLE_CHOICE_1_CORRECT;var b=this.getBestAnswers();this.config.options=b}this.intervention=new Intervention(this.config,a)},createIntervention:function(a,b){return new Intervention(a,b)},setCurrentAnswer:function(a){this.currentAnswerIndex=a,this.currentAnswer=this.getAnswer(a),this.currentAnswer.options&&this.currentAnswer.options.length>1?(this.currentAnswer.options=this.getAvailableOptions(),this.config.analyseAll?this.intervention=new Intervention(this.currentAnswer,Intervention.MULTIPLE_CHOICE_MULT_CORRECT):this.intervention=new Intervention(this.currentAnswer,Intervention.MULTIPLE_CHOICE_1_CORRECT)):this.intervention=new Intervention(this.currentAnswer,Intervention.FEEDBACK),this.numAnswer++,this.config.nrRequiredResponses>1&&(this.givenAnswersWeight+=this.currentAnswer.weight)},getAnswer:function(a){return null==this.config||null==this.config.answers||0>a||a>=this.config.answers.length?null:this.config.answers[a]},eraseCurrentAnswer:function(){this.eraseAnswer(this.currentAnswerIndex)},eraseAnswer:function(a){console.log("this.config.answers[index].isIterativeKey: "+this.config.answers[a].isIterativeKey),this.config.answers[a].isIterativeKey||this.config.answers.splice(a,1)},hasRadialKeys:function(){if(null!=this.config&&null!=this.config.answers)for(var a=0;a<this.config.answers.length;a++)if(this.hasKeyType(Dialog.RADIAL_KEY,a))return!0;return!1},hasPoSTags:function(){if(null!=this.config&&null!=this.config.answers)for(var a=0;a<this.config.answers.length;a++)if(/:[VNARSCTDP]/.test(this.config.answers[a][Dialog.RADIAL_KEY+"Key"]))return!0;return!1},hasSingleCharAnswer:function(){if(null!=this.config&&null!=this.config.answers)for(var a=0;a<this.config.answers.length;a++)if(/^[a-z\d]$/.test(this.config.answers[a][Dialog.REGEX_KEY+"Key"])||/^\([a-z\d]\)$/.test(this.config.answers[a][Dialog.SHORT_KEY+"Key"]))return!0;return!1},hasYesNoAnswer:function(){if(null!=this.config&&null!=this.config.answers)for(var a=0;a<this.config.answers.length;a++)if(/\((SÍ|NO)\)/.test(this.config.answers[a][Dialog.RADIAL_KEY+"Key"]))return!0;return!1},hasKeys:function(){if(null!=this.config&&null!=this.config.answers)for(var a=0;a<this.config.answers.length;a++)if(""!=this.getKeyType(a))return!0;return!1},getKeyType:function(a){return this.hasKeyType(Dialog.RADIAL_KEY,a)?Dialog.RADIAL_KEY:this.hasKeyType(Dialog.DESCARTES_KEY,a)?Dialog.DESCARTES_KEY:this.hasKeyType(Dialog.REGEX_KEY,a)?Dialog.REGEX_KEY:""},getKey:function(a,b){return this.config.answers[b][a+"Key"]},hasKeyType:function(a,b){return this.config.answers[b]&&void 0!==this.config.answers[b][a+"Key"]&&""!=this.config.answers[b][a+"Key"]?!0:!1},getText:function(){return this.config.text},isEndOfDialog:function(){return this.config.endDialog},getNextQuestionId:function(){return this.config.nextQuestion},getWeight:function(){return this.config.weight},getAvailableOptions:function(){for(var a=[],b=0;b<this.currentAnswer.options.length;b++)for(var c=0;c<this.config.answers.length;c++){var d=this.currentAnswer.options[b].replaceArray([/(^[\s]*|[\s]*$)/g,/[\s]+/g],[""," "]),e=this.config.answers[c].bestAnswer.replaceArray([/(^[\s]*|[\s]*$)/g,/[\s]+/g],[""," "]);if(d==e){a.push(d);break}}return a},getBestAnswers:function(){for(var a=[],b=0;b<this.config.answers.length;b++){var c=this.getAnswer(b).bestAnswer;c&&a.push(c)}return a}},Intervention.QUESTION="question",Intervention.FEEDBACK="feedback",Intervention.FEEDBACK_WITH_SEGMENTS="bulletedFeedback",Intervention.FEEDBACK_SEGMENT="bullet",Intervention.PROMPT="prompt",Intervention.MULTIPLE_CHOICE_1_CORRECT="radios",Intervention.MULTIPLE_CHOICE_MULT_CORRECT="checkboxes",Intervention.SWEARWORD="swearword",Intervention.prototype={init:function(){this.text=this.config.text?this.config.text:this.config.feedback,this.emotion=this.config.emotion,this.microworld.display=this.config.display?this.config.display.toString().split(","):[],this.microworld.hide=this.config.hide?this.config.hide.toString().split(","):[],this.microworld.set=this.config.set?this.config.set.toString().split(","):[],this.options=this.type==Intervention.MULTIPLE_CHOICE_MULT_CORRECT||this.type==Intervention.MULTIPLE_CHOICE_1_CORRECT?this.config.options:[]},hasContent:function(){return this.hasActionsMicroworld()||this.text.length>0||this.emotion.length>0},hasActionsMicroworld:function(){return this.hasActionMicroworld("display")||this.hasActionMicroworld("hide")||this.hasActionMicroworld("set")},hasActionMicroworld:function(a){return this.getActionsMicroworld(a).length>0},getActionsMicroworld:function(a){if(this.type==Intervention.FEEDBACK_WITH_SEGMENTS){for(var b=[],c=0;c<this.segments.length;c++){var d=this.segments[c].microworld;d[a].length>0&&(b=b.concat(d[a]))}return b}return this.microworld[a]}},Dialog.DEFAULT_OPTIONS={version:"0.1",withAudio:!1,tts:!1,checkSwearWords:!0,interventionMessages:{radios:"Elige una de las siguientes opciones:",checkboxes:"Selecciona la o las opciones que te parecen correctas.",allAnalysed:"¡Bien hecho!",invalidInput:{noCharacter:"¿¡Qué fue lo que escribiste!? ¡Anda, vuelve a contestar!",singleCharacter:"Se me hace que no tienes muchas ganas de escribir. Anda, haz un esfuerzo.",tooShort:"Hmmm, me parece que no te estás esforzando demasiado, eh. Vuelve a contestar, por favor.",nonLegit:"¡Uy, escribiste un poco raro! ¿Puedes volver a contestar?"},questionNeeded:{wrongStart:["¡Ojo!, el signo que abre la pregunta debe ser la interrogación <strong>invertida</strong> (¿). ¡Observa el signo correcto y recuérdalo bien!<br><br>Presiona ACEPTAR para continuar.","Recuerda, el signo que abre la pregunta debe ser la interrogación <strong>invertida</strong> (¿) .<br><br>Observa el signo correcto y presiona ACEPTAR para continuar.","¡Acuérdate de los signos de interrogación! Obsérvalos bien y pulsa ACEPTAR.","¡Acuérdate de los signos de interrogación!","¡Los signos, no los olvides!"],start:["Parece que me estás preguntando algo, pero no escribiste el signo de apertura de la interrogación. Por esta vez, te echo una manita... <br><br>Presiona ACEPTAR para continuar.","¡Ey!, ¿qué pasó con el signo de interrogación que abre la pregunta? ¡Que no se te olvide! <br><br>Ya lo agregué, tú sólo presiona ACEPTAR.","¡Acuérdate de los signos de interrogación! Obsérvalos bien y pulsa ACEPTAR.","¡Acuérdate de los signos de interrogación!","¡Los signos, no los olvides!"],end:["Creo que me estás preguntando algo, pero se te olvidó poner el signo de interrogación de cierre. Por esta vez, te echo una manita... <br><br>Presiona ACEPTAR para continuar.","¡Ey!, ¿dónde quedó el signo que cierra la pregunta? ¡Que no se te olvide! <br><br>Ya lo agregué, tú sólo presiona ACEPTAR.","¡Acuérdate de los signos de interrogación! Obsérvalos bien y pulsa ACEPTAR.","¡Acuérdate de los signos de interrogación!","¡Los signos, no los olvides!"],both:["Creo que me estás preguntando algo, pero se te olvidó poner los signos de interrogación. Por esta vez, te echo una manita... <br><br>Presiona ACEPTAR para continuar.","¡Ey!, ¿qué pasó con esos signos de interrogación? ¡Que no se te olviden! <br><br>Ya los agregué, tú sólo presiona ACEPTAR.","¡Acuérdate de los signos de interrogación! Obsérvalos bien y pulsa ACEPTAR.","¡Acuérdate de los signos de interrogación!","¡Los signos, no los olvides!"]}},interventionEmotions:{prompt:"anfitrion",glue:"catedratico",radios:"catedratico",checkboxes:"catedratico",allAnalysed:"entusiasmado",invalidInput:{noCharacter:"what",singleCharacter:"triste",tooShort:"what",nonLegit:"sorprendido"},questionNeeded:["catedratico","anfitrion","what","enojado","risa"]},startData:{startFrom:"",startMicroworlds:[]}},Dialog.RADIAL_KEY="RADial",Dialog.SHORT_KEY="short",Dialog.DESCARTES_KEY="Descartes",Dialog.REGEX_KEY="regex",Dialog.prototype={init:function(){for(var a=this.config.questions,b=0;b<a.length;b++)this.questionMap[a[b].id]=b;for(var c=this.config.microWorlds,d=0;d<c.length;d++)this.microworldMap[c[d].id]=d;this.dialogManager.availableFeatures.localstorage===!0&&this._setupLocalStorage(),this.options.tracking&&this._setupTracking(),this._addHook("beforeAnalyzeAnswer",function(a,b){if(a&&" "!=a&&""!=a){if(!/[a-z\d]/i.test(a))return b.addIntervention({text:b.options.interventionMessages.invalidInput.noCharacter,emotion:b.options.interventionEmotions.invalidInput.noCharacter},Intervention.PROMPT),!1;if(!b.currentQuestion.hasSingleCharAnswer()&&1==a.length)return b.addIntervention({text:b.options.interventionMessages.invalidInput.singleCharacter,emotion:b.options.interventionEmotions.invalidInput.singleCharacter},Intervention.PROMPT),!1;for(var c="abcdefghijklmnopqrstuvwxyzñ",d=0;d<c.length;d++)if(b.applyRegEx(c.charAt(d)+"{2,}",a))return b.addIntervention({text:b.options.interventionMessages.invalidInput.nonLegit,emotion:b.options.interventionEmotions.invalidInput.nonLegit},Intervention.PROMPT),!1;var e=/[bcdfghjkpqstvwxyzñ]{3,}/,f=/[bcdfghjklmnpqrstvwxyzñ]{5,}/,g=/[aeiou]{4,}/,h=/s[ií]+/i;return e.test(a)||f.test(a)||g.test(a)&&!h.test(a)?(b.addIntervention({text:b.options.interventionMessages.invalidInput.nonLegit,emotion:b.options.interventionEmotions.invalidInput.nonLegit},Intervention.PROMPT),!1):!0}return!0}),this.config.checkSwearWords&&(this._addHook("beforeAnalyzeAnswer",function(a,b){if(b.options.swearwords.words)for(var c=b.options.swearwords.words,d=0;d<c.length;d++)if(b.applyRegEx(c[d],a))return b.addIntervention(b.getSwearwordIntervention(),Intervention.SWEARWORD),!1;return!0}),this._addHook("beforeAnalyzeAnswer",function(a,b){var c=b.options.colloquialisms;if(c&&c.length>0)for(var d=0;d<c.length;d++)if(b.applyRegEx(c[d].word,a))return b.addIntervention({text:c[d].feedback,emotion:c[d].emotion},Intervention.SWEARWORD),b.dialogManager.ui.eraseInput=!1,jsKeyboard.currentElement.val(a),!1;return!0})),this.keysAnalysis[Dialog.RADIAL_KEY]=jQuery.proxy(this.compareWithRadialKey,this),this.keysAnalysis[Dialog.DESCARTES_KEY]=jQuery.proxy(this.compareWithDescartesKey,this),this.keysAnalysis[Dialog.REGEX_KEY]=jQuery.proxy(this.compareWithRegexKey,this)},_addHook:function(a,b){null==this.hooks[a]&&(this.hooks[a]=[]),this.hooks[a].push(b)},_callHook:function(a,b){if("undefined"!=typeof this.hooks[a])for(var c,d=0;d<this.hooks[a].length;d++){null==b&&(b=[]);for(var e=[],f=0;f<b.length;f++)e.push(b[f]);if(e.push(this),c=this.hooks[a][d],!c.apply(c,e))return!1}return!0},_clearHooks:function(a){"undefined"!=typeof this.hooks[a]&&(this.hooks[a]=[])},_setupLocalStorage:function(){Modernizr.localstorage&&(this.options.storage=window.localStorage,this._addHook("beforeAnalyzeAnswer",function(a,b){var c=b.config.title+b.config.version+"_respuestas";return b.addAnswerToLSData(c,a),!0}))},_saveToLocalStorage:function(a,b){var c=this.options.storage;c&&c.setItem(a,b)},_getValueFromLocalStorage:function(a){var b=this.options.storage;return b?b.getItem(a):null},_resetItemInLocalStorage:function(a){var b=this.config.title+this.config.version+"_respuestas";null!=a&&(b=a),this._saveToLocalStorage(b,"")},addAnswerToLSData:function(a,b,c){var d=this._getValueFromLocalStorage(a),e=b;d&&""!=d&&(e=d+"|"+b),c===!0&&(e=b),this._saveToLocalStorage(a,e)},addMwSettingToLS:function(a,b){var c,d=this.config.title+this.config.version+"_micromundos",e=this._getValueFromLocalStorage(d);if(e&&""!=e){for(var f=!1,g=e.split("|"),h=0;h<g.length;h++){var i=g[h].split("::")[0];if(i==a){g[h]=g[h]+","+b,f=!0;break}}c=f?g.join("|"):e+"|"+a+"::"+b}else c=a+"::"+b;this._saveToLocalStorage(d,c)},getMwSettingsFromLS:function(a){var b=this.config.title+this.config.version+"_micromundos",c=this._getValueFromLocalStorage(b);if(c&&""!=c)for(var d=c.split("|"),e=0;e<d.length;e++){var f=d[e].split("::")[0];if(f==a)return d[e].split("::")[1]}return""},_setupTracking:function(){this.options.eventAttachElement=jQuery("<p></p>");new DialogRegister(this.options.eventAttachElement),this.config},getQuestion:function(a){var b=a;return"string"==typeof a&&(b=this.questionMap[a]),b>=0?new Question(this.config.questions[b]):null},start:function(a){null!=a&&(this.options.startData=a);var b=this.options.startData.startMicroworlds;b&&b.length>0&&(this.createMicroworlds(b,!0),this.dialogManager.ui.createMwLinks(b)),this._resetItemInLocalStorage(this.config.title+this.config.version+"_micromundos");var c=this.options.startData.startFrom?this.options.startData.startFrom:this.config.firstQuestion?this.config.firstQuestion:0;this.startFromQuestion(c)},startFromQuestion:function(a){this._resetItemInLocalStorage(),this._saveToLocalStorage(this.config.title+this.config.version+"_startFrom",a),this.setCurrentQuestion(a)},setCurrentQuestion:function(a){if(this.questionHolder[a]&&this.questionHolder[a].givenAnswersWeight==this.questionHolder[a].config.nrRequiredResponses&&(a=this.questionHolder[a].config.nextQuestion),null==this.questionHolder[a])this.currentQuestion=this.getQuestion(a),this.interventions.push(this.currentQuestion.intervention),this.prepareMicroworlds(),this.checkQuestionStatus();else{if(this.currentQuestion=this.questionHolder[a],this.currentQuestion.status=Question.WAITING_ANSWER,
this.currentQuestion.config.showBestAnswers){var b=this.currentQuestion.getBestAnswers(),c={text:this.currentQuestion.config.prompt,emotion:this.options.interventionEmotions[Intervention.PROMPT],options:b};this.currentQuestion.config.analyseAll?this.addIntervention(c,Intervention.MULTIPLE_CHOICE_MULT_CORRECT):this.addIntervention(c,Intervention.MULTIPLE_CHOICE_1_CORRECT)}else this.addIntervention({text:this.currentQuestion.config.prompt,emotion:this.options.interventionEmotions[Intervention.PROMPT]},Intervention.PROMPT);this.interventionsReady()}},prepareMicroworlds:function(){if(null!=this.currentQuestion.intervention&&this.currentQuestion.intervention.hasActionMicroworld("display")){var a=this.currentQuestion.intervention.getActionsMicroworld("display");this.createMicroworlds(a,this.rebuilding)}},createMicroworlds:function(a,b){for(var c,d,e=0;e<a.length;e++)if(d=this.config.microWorlds[this.microworldMap[a[e]]],null!=d&&null==this.microworldHolder[d.id]){if(c=MicroworldFactory.create(d.type,d),b)if(c.isActive=!1,this.rebuilding){if(c.reconstructionData=this.getMwSettingsFromLS(a[e]),""!=c.reconstructionData)for(var f=c.reconstructionData.split(","),e=0;e<f.length;e++)c.mwSettings.mw.push(f[e])}else c.reconstructionData="default";this.microworldHolder[d.id]=c}},checkQuestionStatus:function(){0==this.currentQuestion.config.nrRequiredResponses?(this.currentQuestion.status=Question.DONE,this.setCurrentQuestion(this.currentQuestion.config.nextQuestion)):this.interventionsReady()},interventionsReady:function(){var a=this._callHook("beforeInterventionsReady",arguments);a&&(this.dialogManager.ui.showInterventions(this.interventions),this.interventions=[],this.checkEndDialog())},analyzeAnswer:function(a){var b=this._callHook("beforeAnalyzeAnswer",arguments);return b?(this.answerText=a,a=this.cleanString(a),a=this.addRememberedKeys(a),this.currentQuestion.hasRadialKeys()&&(this.currentLemmas=getLemasJS(a,this.currentQuestion.hasPoSTags())),void(this.findMatch(a)||this.createMultipleChoiceFeedback())):void this.interventionsReady()},addRememberedKeys:function(a){return this.currentQuestion.currentAnswer&&this.currentQuestion.currentAnswer.rememberKey&&(a=this.currentQuestion.currentAnswer.rememberKey+" "+a),a},findMatch:function(a){for(var b=0;b<this.currentQuestion.config.answers.length;b++)if(this.answerMatchesKey(a,b)){if(this.only1Answer(b))return this.questionNeeded(a,b)||(this.currentQuestion.setCurrentAnswer(b),this.currentQuestion.intervention.hasContent()&&(this.interventions.push(this.insertKey(this.currentQuestion.intervention,this.matchedLemmas)),this.prepareMicroworlds(),this.currentQuestion.currentAnswer.dontErase&&(this.dialogManager.ui.eraseInput=!1,jsKeyboard.currentElement.val(this.answerText))),this.checkNextQuestion()),!0;this.multipleAnswers(b)&&(this.currentQuestion.givenAnswers.push(b),this.currentQuestion.lemmas.push(this.matchedLemmas))}return this.checkGivenAnswers()},only1Answer:function(a){return 1==this.currentQuestion.config.nrRequiredResponses||!this.currentQuestion.config.analyseAll||0==this.currentQuestion.givenAnswers.length&&(""==this.currentQuestion.getKeyType(a)||/(DUDA|SÍ|NO)/.test(this.currentQuestion.getKey(Dialog.RADIAL_KEY,a))||""!=this.currentQuestion.getAnswer(a).nextQuestion)?!0:!1},multipleAnswers:function(a){return this.currentQuestion.config.analyseAll&&""!=this.currentQuestion.getKeyType(a)&&!/(DUDA|SÍ|NO)/.test(this.currentQuestion.getKey(Dialog.RADIAL_KEY,a))&&""==this.currentQuestion.getAnswer(a).nextQuestion?!0:!1},questionNeeded:function(a,b){if(this.currentQuestion.config.answers[b].isQuestion&&!/^¿(.+)\?$/.test(a)){/^\?/.test(a)?this.addIntervention({text:this.options.interventionMessages.questionNeeded.wrongStart[this.nrQuestionNeeded],emotion:this.options.interventionEmotions.questionNeeded[this.nrQuestionNeeded]},Intervention.PROMPT):/^¿/.test(a)||/\?$/.test(a)?/^¿/.test(a)?this.addIntervention({text:this.options.interventionMessages.questionNeeded.end[this.nrQuestionNeeded],emotion:this.options.interventionEmotions.questionNeeded[this.nrQuestionNeeded]},Intervention.PROMPT):this.addIntervention({text:this.options.interventionMessages.questionNeeded.start[this.nrQuestionNeeded],emotion:this.options.interventionEmotions.questionNeeded[this.nrQuestionNeeded]},Intervention.PROMPT):this.addIntervention({text:this.options.interventionMessages.questionNeeded.both[this.nrQuestionNeeded],emotion:this.options.interventionEmotions.questionNeeded[this.nrQuestionNeeded]},Intervention.PROMPT),this.dialogManager.ui.eraseInput=!1,this.interventionsReady();var c=a;return/^¿/.test(a)||(c=/^\?/.test(a)?"¿"+c.substring(1):"¿"+c),/\?$/.test(a)||(c+="?"),this.dialogManager.ui.inputField.html(c),jsKeyboard.currentElement.val(c),this.nrQuestionNeeded=this.nrQuestionNeeded<4?this.nrQuestionNeeded+1:0,!0}return!1},checkGivenAnswers:function(){return this.currentQuestion.givenAnswers.length>0?(this.interventions.push(this.createSegmentedIntervention()),this.currentQuestion.givenAnswersWeight>=this.currentQuestion.config.nrRequiredResponses?(this.addIntervention({text:"<p>"+this.options.interventionMessages.allAnalysed+"</p>",emotion:this.options.interventionEmotions.allAnalysed},Intervention.FEEDBACK),this.setCurrentQuestion(this.currentQuestion.config.nextQuestion)):(this.addIntervention({text:this.currentQuestion.config.prompt,emotion:this.options.interventionEmotions[Intervention.PROMPT]},Intervention.PROMPT),this.interventionsReady()),!0):!1},checkNextQuestion:function(){if(""!=this.currentQuestion.currentAnswer.nextQuestion&&null!=this.questionMap[this.currentQuestion.currentAnswer.nextQuestion]){var a=this.currentQuestion.currentAnswer.nextQuestion;1==this.currentQuestion.config.nrRequiredResponses?this.currentQuestion.status=Question.DONE:this.currentQuestion.config.nrRequiredResponses>1&&(this.currentQuestion.eraseCurrentAnswer(),this.currentQuestion.status=Question.STANDBY,this.questionHolder[this.currentQuestion.id]=this.currentQuestion),this.setCurrentQuestion(a)}else if(this.currentQuestion.eraseCurrentAnswer(),1==this.currentQuestion.config.nrRequiredResponses||this.currentQuestion.config.analyseAll)this.interventionsReady();else if(this.currentQuestion.config.nrRequiredResponses>1)if(this.currentQuestion.givenAnswersWeight>=this.currentQuestion.config.nrRequiredResponses)this.setCurrentQuestion(this.currentQuestion.config.nextQuestion);else{if(this.currentQuestion.currentAnswer.weight>0)if(this.currentQuestion.config.showBestAnswers){var b=this.currentQuestion.getBestAnswers(),c={text:this.currentQuestion.config.prompt,emotion:this.options.interventionEmotions[Intervention.PROMPT],options:b};this.currentQuestion.config.analyseAll?this.addIntervention(c,Intervention.MULTIPLE_CHOICE_MULT_CORRECT):this.addIntervention(c,Intervention.MULTIPLE_CHOICE_1_CORRECT)}else this.addIntervention({text:this.currentQuestion.config.prompt,emotion:this.options.interventionEmotions[Intervention.PROMPT]},Intervention.PROMPT);this.interventionsReady()}},answerMatchesKey:function(a,b){var c=this.currentQuestion.getKeyType(b);if(""!=c){var d=this.currentQuestion.getKey(c,b);return this.keysAnalysis[c](a,d)}return!0},compareWithRadialKey:function(a,b){return this.treeNode=crearArbol(b),this.huboNeg=!1,this.huboNegado=!1,this.arrPosNeg=[],this.matchedLemmas=[],null!=this.treeNode?this.treeNode.analizar(1)?!0:this.huboNeg&&this.huboNegado?this.treeNode.analizar(2):!1:(console.log("Error in key "+b),!1)},compareWithDescartesKey:function(a,b){if(/\d/.test(b)&&/\d/.test(a)){var c=a.match(/([\d]+[\.]?[\d]*)/),d=parseFloat(c[0]);return descartesJS.escorrecto(b,d)}var e=/AND/g,f=/OR/g;return b=b.replace(e,"&"),b=b.replace(f,"|"),"off"==this.config.spellcheck?descartesJS.esCorrecto(b,a):descartesJS.escorrecto(b,a)},compareWithRegexKey:function(a,b){return this.applyRegEx(b,a)},getSwearwordIntervention:function(){var a=this.options.swearwords.interventions;return this.currNumSwearword++,this.currNumSwearword>=a.length-1?a[a.length-1]:a[this.currNumSwearword]},checkEndDialog:function(){(this.currentQuestion.config.endDialogue||this.currentQuestion.currentAnswer&&this.currentQuestion.currentAnswer.endDialogue)&&this.dialogManager.ui.endDialog()},createMultipleChoiceFeedback:function(){var a=this.currentQuestion.getBestAnswers();a.length>0?(this.currentQuestion.config.analyseAll?this.addIntervention({text:this.options.interventionMessages[Intervention.MULTIPLE_CHOICE_MULT_CORRECT],emotion:this.options.interventionEmotions[Intervention.MULTIPLE_CHOICE_MULT_CORRECT],options:a},Intervention.MULTIPLE_CHOICE_MULT_CORRECT):this.addIntervention({text:this.options.interventionMessages[Intervention.MULTIPLE_CHOICE_1_CORRECT],emotion:this.options.interventionEmotions[Intervention.MULTIPLE_CHOICE_1_CORRECT],options:a},Intervention.MULTIPLE_CHOICE_1_CORRECT),this.interventionsReady()):console.log("ERROR in dialogo.json: No more matches and no best answers for this questions!")},setConfig:function(a){this.config=a},configMicroworld:function(){},getInterventionText:function(){},addIntervention:function(a,b){this.interventions.push(this.currentQuestion.createIntervention(a,b))},applyRegEx:function(a,b){if(/^\//.test(a)){var c=a.replace(/(^\/|\/$)/g,"");return new RegExp(c,"").test(b)?!0:!1}if(/[\^\$]/.test(a))return new RegExp(a,"i").test(b)?!0:!1;var d=new RegExp("[\\s¡¿]"+a+"[\\s\\.,;\\?\\!]","i"),e=new RegExp("^"+a+"[\\s\\.,;\\?\\!]","i"),f=new RegExp("[\\s¡¿]"+a+"$","i"),g=new RegExp("^"+a+"$","i");return d.test(b)||e.test(b)||f.test(b)||g.test(b)?!0:!1},cleanString:function(a){return a=a.replace(/[\s]+/g," "),a=a.replace(/\<(\/)?sub\>/g,""),a=a.replace(/\<(\/)?sup\>/g,"")},insertKey:function(a,b){return/##/.test(a.text)&&(b.length>0?a.text=a.text.replace("##",b[0]):a.text=a.text.replace("##",this.answerText)),a},createSegmentedIntervention:function(){for(var a=0;a<this.currentQuestion.givenAnswers.length;a++)this.currentQuestion.givenAnswersWeight+=this.currentQuestion.getAnswer(this.currentQuestion.givenAnswers[a]).weight;return this.currentQuestion.intervention=this.currentQuestion.createIntervention({text:this.currentQuestion.config.glue,emotion:this.options.interventionEmotions.glue},Intervention.FEEDBACK_WITH_SEGMENTS),this.currentQuestion.intervention.segments=this.createSegments(),this.currentQuestion.givenAnswers=[],this.currentQuestion.lemmas=[],this.currentQuestion.intervention},createSegments:function(){for(var a=[],b=this.currentQuestion.givenAnswers,c=0;c<b.length;c++){var d=this.currentQuestion.createIntervention(this.currentQuestion.getAnswer(b[c]),Intervention.FEEDBACK_SEGMENT);d=this.insertKey(d,this.currentQuestion.lemmas[c]),a.push(d)}for(var e=b.length-1;e>=0;e--)this.currentQuestion.eraseAnswer(b[e]);return a},rebuild:function(){var a=this,b=this.config.title+this.config.version+"_respuestas",c=this._getValueFromLocalStorage(b);this._resetItemInLocalStorage(b);var d=this.config.title+this.config.version+"_startFrom",e=this._getValueFromLocalStorage(d),f=[];null!=c&&c.length>0&&(f=c.split("|")),f.length>0?(this.rebuilding=!0,this.dialogManager.ui.setRebuilding(!0),this._addHook("beforeInterventionsReady",function(b,c){return function(d){return d.dialogManager.ui.showInterventionsRebuild(d.interventions),d.interventions=[],b.length>0&&(/[\w\d]/i.test(b[0])&&d.dialogManager.ui.showBalloonStudentRebuild(b[0]),1==b.length&&(d._clearHooks("beforeInterventionsReady"),a.rebuilding=!1,d.dialogManager.ui.setRebuilding(!1)),d.dialogManager.ui.updateRebuildProgress(1-b.length/c),setTimeout(function(){d.analyzeAnswer(b.shift())},10)),!1}}(f,f.length)),this.startFromQuestion(e)):this.start()}},AvatarDialogUI.DEFAULT_OPTIONS={charDelay:60,gender:"",GENDER:{WOMAN:{value:0,replaceChar:"a",regex:/^alumna/},MAN:{value:1,replaceChar:"o",regex:/^alumno/},NEUTRAL:{value:2,replaceChar:"o",regex:/^alumno/}}},AvatarDialogUI.prototype={load:function(){},init:function(){var a=this;this.dialogContainer=jQuery("#contenedor"),this.microworldContainer=jQuery("#micromundo"),this.microworldPopup=jQuery("#popupMicromundos"),this.plastaPopup=jQuery("#plastaPopup"),this.microworldContainerFront=jQuery("#popupMicromundos_inner"),this.microworldContainerVisited=jQuery("#micromundoVisitado"),this.btClosePopupMW=jQuery("#bt_cerrar_pop_micromundo"),this.chatGlobo=jQuery("#chat_globos"),this.chatButton=jQuery("#btHistorial"),this.scrollContainer=null,this.inputField=jQuery("#text_alumno"),this.tutorInterventionField=$("#text_tutor"),this.initializeElementsAvatarUI(),this.btClosePopupMW.on("click",function(){a.closePopupMicroworld()}),this.interventionDecorators[Intervention.QUESTION]=jQuery.proxy(this.typeQUESTION,this),this.interventionDecorators[Intervention.FEEDBACK]=jQuery.proxy(this.typeFEEDBACK,this),this.interventionDecorators[Intervention.PROMPT]=jQuery.proxy(this.typePROMPT,this),this.interventionDecorators[Intervention.FEEDBACK_WITH_SEGMENTS]=jQuery.proxy(this.typeFEEDBACK_WITH_SEGMENTS,this),this.interventionDecorators[Intervention.MULTIPLE_CHOICE_1_CORRECT]=jQuery.proxy(this.typeMULTIPLE_CHOICE_1_CORRECT,this),this.interventionDecorators[Intervention.MULTIPLE_CHOICE_MULT_CORRECT]=jQuery.proxy(this.typeMULTIPLE_CHOICE_MULT_CORRECT,this),this.interventionDecorators[Intervention.SWEARWORD]=jQuery.proxy(this.typeSWEARWORD,this),this.interventionDecorators[Intervention.ANSWER]=jQuery.proxy(this.typeANSWER,this)},initializeElementsAvatarUI:function(){initializeKeyboard("virtualKeyboardDialog","text_alumno"),this.prepareInterventionSound(),$("#div_tutor .avatar_tutor").addClass("flash"),this.options.GENDER.WOMAN.regex.test(this.options.userData.userAvatar)?this.options.gender="WOMAN":this.options.gender="MAN",$(".avatar_alumno").css("background-image",'url("img/alumno/'+this.options.userData.userAvatar+'.png")');var a=this;this.chatButton.bind("click",function(){a.showChat()}),this.addCustomScrollbar()},prepareInterventionSound:function(){if(this.dialogManager.availableFeatures.audio&&this.dialogManager.availableFeatures.audio_mp3){this.sound=document.createElement("audio"),this.sound.setAttribute("id","interventionSound");var a=document.createElement("source");a.setAttribute("src","audio/interventionSound.mp3"),a.setAttribute("type","audio/mpeg"),this.sound.appendChild(a),this.sound.load()}},addCustomScrollbar:function(){this.chatGlobo.mCustomScrollbar({theme:"inset-2-dark",scrollbarPosition:"inside",autoHideScrollbar:!1,scrollButtons:{enable:!0,scrollAmount:40},advanced:{updateOnContentResize:!0}}),this.scrollContainer=jQuery("#mCSB_1_container")},updateScroll:function(){this.chatGlobo.mCustomScrollbar("update"),this.chatGlobo.mCustomScrollbar("scrollTo","bottom")},showChat:function(){var a=this;$("#historial_chat").css("visibility","visible"),this.chatButton.addClass("colapsar"),this.chatButton.attr("title","Haz clic aquí para esconder el diálogo completo."),this.chatButton.unbind("click"),this.chatButton.bind("click",function(){a.hideChat()})},hideChat:function(){var a=this;$("#historial_chat").css("visibility","hidden"),this.chatButton.removeClass("colapsar"),this.chatButton.attr("title","Haz clic aquí para mostrar el diálogo completo."),this.chatButton.unbind("click"),this.chatButton.bind("click",function(){a.showChat()})},showIntervention:function(a){this.interventionCount++;var b=this.interventionDecorators[a.type](a);if(b){b=this.processInterventionText(b),this.rebuilding||this.showInterventionAvatarUI(b,a.emotion);var c=this.createBalloonTutor(a),d=jQuery('<div class="txt_avatar"></div>');d.html(b),c.append(d),this.scrollContainer.append(c),this.updateScroll(),this.activateLinks(),this.rebuilding||this.activateInputs(a),this.deactivateInputCopies()}this.doMicroworlds(a)},processInterventionText:function(a){return"WOMAN"==this.options.gender?(a=a.replace(/ un@/g," una"),a=a.replace(/dor@/g,"dora")):(a=a.replace(/ un@/g," un"),a=a.replace(/dor@/g,"dor")),a=a.replace(/@/g,this.options.GENDER[this.options.gender].replaceChar),a=a.replace(/(\[nombre\])/gi,this.options.userData.userName),a=this.changeHTMLCodes(a),a=this.addLinks(a)},changeHTMLCodes:function(a){for(;a.match(/<(\/?[^>]+)>/);)a=a.replace(/<(\/?[^>]+)>/,"[["+RegExp.$1+"]]");for(var b=$("<div/>").html(a).text();b.match(/\[\[(\/?[^\]]+)\]\]/);)b=b.replace(/\[\[(\/?[^\]]+)\]\]/,"<"+RegExp.$1+">");return b},showInterventionAvatarUI:function(a,b){this.tutorInterventionField.html(this.tutorInterventionField.html()+a),b&&$("#img_tutor").attr("src","img/tutor/"+b+".png"),$("#div_tutor").height()<$("#text_tutor").height()+10&&($("#div_tutor").addClass("overflow"),this.hideParagraphs())},hideParagraphs:function(){for(var a=1;a<$(".overflow .par").length;a++){var b=$(".overflow .par:nth-child("+a+")");if(!b.hasClass("isHiddenPar")&&(b.addClass("isHiddenPar"),this.hiddenParagraphs++,this.fromTop=this.hiddenParagraphs,$("#div_tutor").height()>$("#text_tutor").height()+10))return}},changeHiddenPars:function(){for(var a=this.hiddenParagraphs-this.fromTop,b=0;b<$(".overflow .par").length;b++){var c=$(".overflow .par:nth-child("+(b+1)+")");b<this.fromTop||b>=$(".overflow .par").length-a?c.hasClass("isHiddenPar")||c.addClass("isHiddenPar"):c.hasClass("isHiddenPar")&&c.removeClass("isHiddenPar")}},enableScrollUp:function(){var a=this;$("#div_tutor").addClass("canScrollUp"),$("#scrollUp").on("click",function(){a.scrollUp()})},scrollUp:function(){var a=this;this.fromTop--,this.changeHiddenPars(),0==this.fromTop&&($("#scrollUp").off(),$("#div_tutor").removeClass("canScrollUp")),$("#div_tutor").hasClass("canScrollDown")||($("#div_tutor").addClass("canScrollDown"),$("#scrollDown").on("click",function(){a.scrollDown()}))},scrollDown:function(){this.fromTop++,this.changeHiddenPars(),this.fromTop==this.hiddenParagraphs&&($("#scrollDown").off(),$("#div_tutor").removeClass("canScrollDown")),$("#div_tutor").hasClass("canScrollUp")||this.enableScrollUp()},showBalloonStudent:function(a){var b=jQuery('<div class="globo_usuario"></div>'),c=jQuery('<div class="txt_usuario"></div>');c.html(a),b.append(c);var d=jQuery("<div/>");d.attr({"class":"avatar_alumno",style:'background-image: url("img/alumno/'+this.options.userData.userAvatar+'.png");'}),b.append(d),b.addClass("answer"),b.attr("data-tipo","answer"),this.scrollContainer.append(b),this.updateScroll()},showBalloonStudentRebuild:function(a){this.answerText=a,this.showBalloonStudent(a);var b=$('.intervencion[data-id="'+this.interventionCount+'"]'),c=a.split(",");(b.hasClass("radios")||b.hasClass("checkboxes"))&&this.checkInterventionInput(b,c)},createBalloonTutor:function(a){var b=jQuery('<div class="globo_tutor" data-id="'+this.interventionCount+'"></div>'),c=jQuery("<div/>");c.attr({"class":"avatar_tutor",css:"margin: 1px !important"}),b.append(c);var d=jQuery("<img/>");return d.attr({"class":"img_tutor_class",src:"img/tutor/"+a.emotion+".png"}),c.append(d),b.addClass("intervencion"),b.addClass(a.type),b.attr("data-tipo",a.type),b},typeQUESTION:function(a){return this.addParClass(a.text)},typeFEEDBACK:function(a){return this.addParClass(a.text)},typeSWEARWORD:function(a){return this.addParClass(a.text)},typePROMPT:function(a){return this.addParClass(a.text)},typeFEEDBACK_WITH_SEGMENTS:function(a){var b=this.addParClass(a.text);b+=a.segments.length<2?"<ul class='par singleSegment'>":"<ul class='par'>";for(var c=0;c<a.segments.length;c++)b+="<li class='txtBullet'>"+this.eliminatePars(a.segments[c].text)+"</li>";return b+="</ul>"},typeMULTIPLE_CHOICE_1_CORRECT:function(a){var b=this.addParClass(a.text);b+='<ul class="par radio-group">';for(var c="radioGroup"+this.interventionCount,d=0;d<a.options.length;d++)b+="<li>",b+="<label>",b+='<input data-name="'+(c+"_"+d)+'" class="optionRadio cursor input" type="radio" name="'+c+'" value="'+a.options[d]+'" ></input>',b+='<span class="optionTxt">'+a.options[d]+"</span>",b+="</label>",b+="</li>";return b+="</ul>"},typeMULTIPLE_CHOICE_MULT_CORRECT:function(a){var b=this.addParClass(a.text);b+='<ul class="par check-group">';for(var c="checkGroup"+this.interventionCount,d=0;d<a.options.length;d++)b+="<li>",b+="<label>",b+='<input data-name="'+(c+"_"+d)+'" data-group="'+c+'" class="optionCheck cursor input" type="checkbox" name="'+c+'" value="'+a.options[d]+'" ></input>',b+='<span class="optionTxt">'+a.options[d]+"</span>",b+="</label>",b+="</li>";return b+="</ul>",b+='<a href="#" class="btn_checkGroup" data-group="'+c+'" >Confirmar</a>'},addParClass:function(a){return a=/^<p>/.test(a)?a.replace(/<p>/g,'<p class="par">'):'<p class="par">'+a+"</p>"},eliminatePars:function(a){return a=a.replace(/<p( class=\"par\")?>/g,""),a=a.replace(/<\/p>/g,"")},addLinks:function(a){for(var b=0;b<definiciones.length;b++)if(this.checkTermsGlossed(b))for(var c=definiciones[b].trm.split(","),d=0;d<c.length;d++){var e=c[d];if(e=e.replace(/(^[\s]+|[\s]+$)/,"")){var f=new RegExp("([^\\wáéíóúüñ])"+e+"([^\\wáéíúóüñ])","i"),g=new RegExp("^"+e+"([^\\wáéíúóüñ])","i"),h=new RegExp("[^\\wáéíúóüñ]"+e+"</a>","i"),i=new RegExp("define[^\\w]+"+e,"i");if(!h.test(a)&&!i.test(a)){var j=f.exec(a),k=g.exec(a);if(j){a=a.substr(0,j.index+1)+"<a href='#' data-term='"+definiciones[b].trm+"' class='ligaDefinicion'>"+j[0].substr(1,j[0].length-2)+"</a>"+a.substr(j.index+e.length+1),this.updateTermsGlossed(b);break}if(k){a="<a href='#' data-term='"+definiciones[b].trm+"' class='ligaDefinicion'>"+k[0].substr(0,k[0].length-1)+"</a>"+a.substr(k.index+e.length),this.updateTermsGlossed(b);break}}}}return a},checkTermsGlossed:function(a){return a in this.termsGlossed?void 0===definiciones[a].frecuency?this.termsGlossed[a]<2?!0:!1:"siempre"==definiciones[a].frecuency?!0:this.termsGlossed[a]<definiciones[a].frecuency?!0:!1:(this.termsGlossed[a]=0,!0)},updateTermsGlossed:function(a){this.termsGlossed[a]=this.termsGlossed[a]+1},activateLinks:function(){var a=this;jQuery(".ligaDefinicion").on("click",function(){var b=jQuery(this).data("term");a.showDefinition(b)})},activateInputs:function(a){if(a.type==Intervention.MULTIPLE_CHOICE_1_CORRECT){this.multipleChoice=!0;var b=this;jQuery(".input",this.scrollContainer).each(function(){jQuery(this).attr("name",jQuery(this).attr("name")+"_copy")}),jQuery(".input",this.tutorInterventionField).on("click",function(){jQuery(this).off();var a=jQuery(this).val();b.showInterventionStudent(a);var c=jQuery('[data-name="'+jQuery(this).data("name")+'"]',b.scrollContainer);c.prop("checked",!0)})}else if(a.type==Intervention.MULTIPLE_CHOICE_MULT_CORRECT){this.multipleChoice=!0;var b=this;jQuery(".input",this.tutorInterventionField).on("click",function(){var a=jQuery('[data-name="'+jQuery(this).data("name")+'"]',b.scrollContainer);a.prop("checked",jQuery(this).prop("checked"));var c=jQuery('[data-group="'+jQuery(this).data("group")+'"]:checked',b.tutorInterventionField).length;1==c?b.activateBtnCheckGroup(!0):0==c&&b.activateBtnCheckGroup(!1)})}},activateBtnCheckGroup:function(a){var b=this;a?jQuery(".btn_checkGroup",this.tutorInterventionField).on("click",function(){var a="";jQuery('[data-group="'+jQuery(this).data("group")+'"]:checked',b.tutorInterventionField).each(function(){a=""==a?jQuery(this).val():a+", "+jQuery(this).val()}),jQuery(this).prop("disabled",!0),jQuery(this).off(),b.showInterventionStudent(a)}):jQuery(".btn_checkGroup",this.tutorInterventionField).off()},deactivateInputCopies:function(){jQuery(".input",this.scrollContainer).prop("disabled",!0),jQuery(".input",this.scrollContainer).removeClass("cursor")},checkInterventionInput:function(a,b){var c,d;jQuery(".btn_checkGroup",a).off(),jQuery("input",a).each(function(){c=jQuery(this),d=b.indexOf(this.value),-1!=d&&(c.prop("checked",!0),b.splice(d,1))})},showDefinition:function(a){for(var b=this,c=0;c<definiciones.length;c++)if(definiciones[c].trm.toLowerCase()==a.toLowerCase()){var d=definiciones[c].def,e=definiciones[c].img;break}if(0==b.dialogContainer.find(".ventana_definicion").length){var f=jQuery("<div/>");f.attr({"class":"ventana_definicion",style:"z-index: 101"}),b.dialogContainer.append(f),jQuery("<div/>",{"class":"div_interior_definicion"}).appendTo(".ventana_definicion"),jQuery("<p/>",{"class":"texto_definicion"}).appendTo(".div_interior_definicion"),jQuery("<img/>",{"class":"imagen_definicion"}).appendTo(".div_interior_definicion"),jQuery("<a/>",{"class":"btCerrar",title:"Haz clic aquí para cerrar esta ventana."}).appendTo(".ventana_definicion"),jQuery(".ventana_definicion .btCerrar").text("X"),jQuery(".ventana_definicion .btCerrar").bind("click",function(a){$(".ventana_definicion").remove(),b.plastaPopup.addClass("oculto")}),b.plastaPopup.removeClass("oculto"),b.plastaPopup.css("z-index",100)}if(jQuery(".texto_definicion").html(d),jQuery(".imagen_definicion").attr("src",e),e)jQuery(".imagen_definicion").css("visibility","visible"),setTimeout(function(){var a=(b.dialogContainer.height()-f.height())/2;$(".ventana_definicion").css("top",a)},800);else{jQuery(".imagen_definicion").css("visibility","hidden");var g=(b.dialogContainer.height()-f.height())/2;$(".ventana_definicion").css("top",g)}},_showInterventionPromise:function(a){var b=this;return new Promise(function(c,d){var e=jQuery("<p>"+a.text+"</p>").text().length,f=a.config.delay?a.config.delay:b.options.charDelay,g=""==a.text?1:e*f>=2e3?e*f:2e3;b.showIntervention(a),window.setTimeout(function(){c()},g)})},_showInterventionPromiseStudent:function(a){return/[\w\d]/i.test(a)&&this.showBalloonStudent(a),new Promise(function(a,b){window.setTimeout(function(){a()},1e3)})},showInterventions:function(a){this.prepareForNewInterventions(),this.showInterventionsWithDelay(a)},showInterventionsRebuild:function(a){for(var b=0;b<a.length;b++)this.showIntervention(a[b])},updateRebuildProgress:function(a){$(".cargador .texto").text("Cargando... "+parseInt(100*a)+"%")},prepareForNewInterventions:function(){this.inputDisabled=!1,this.eraseInput&&this.disableInput(),this.tutorInterventionField.html(""),$("#div_tutor").removeClass("overflow"),this.hiddenParagraphs=0,this.fromTop=0,this.playInterventionSound(),this.flashTutorBackgrnd(0)},playInterventionSound:function(){this.sound&&this.sound.play()},flashTutorBackgrnd:function(a){var b,c=this,d=a+1;b=1==d||3==d?"#05524f":"#5dd0cb",this._flashPromise(b).then(function(){return 4>d?c.flashTutorBackgrnd(d):void 0})["catch"](function(a){console.error(a),console.error("ERROR in _flashPromise")})},_flashPromise:function(a){return $(".avatar_tutor").css("background-color",a),new Promise(function(a,b){window.setTimeout(function(){a()},500)})},showInterventionsWithDelay:function(a){var b=this,c=[].concat(a),d=c.shift();this._showInterventionPromise(d).then(function(){return c.length>0?b.showInterventionsWithDelay(c):(b.multipleChoice||b.enableInput(),void(b.hiddenParagraphs>0&&b.enableScrollUp()))})["catch"](function(a){console.error(a),console.error("ERROR in _showInterventionPromise :"+d)})},showInterventionsStudent:function(a){this.showInterventionStudent(a)},showInterventionStudent:function(a){var b=this;this.multipleChoice=!1,this.eraseInput=!0,this.answerText=a,""!=a&&a!=this.inputField.html()&&this.inputField.html(a),this._showInterventionPromiseStudent(a).then(function(){$("#img_tutor").attr("src","img/tutor/procesando.png"),b.tutorInterventionField.html("..."),setTimeout(function(){b.dialogManager.dialog.analyzeAnswer(a)},1e3)})["catch"](function(b){console.error(b),console.error("ERROR in showInterventionStudent :"+a)}),this.inputField.removeClass("txt_alumno_writing").addClass("txt_alumno_accepted")},checkStyleInput:function(){this.inputField.hasClass("txt_alumno_erased")&&this.inputField.removeClass("txt_alumno_erased"),this.inputField.addClass("txt_alumno_writing")},showMessageWindow:function(a){console.log("AvatarDialogUI.showMessageWindow :::: "+a)},updateUI:function(){console.log("AvatarDialogUI.updateUI")},showMicroworld:function(a){for(var b,c=0;c<a.length;c++)b=this.dialogManager.dialog.microworldHolder[a[c]],this.lastMw=b,b.config.front?(this.showPopupMicroworld(b),this.rebuilding||(b.isActive=!0)):(this.displayMicroworld(b,this.microworldContainer),this.rebuilding||(b.isActive=!0)),b.config.deactivateChat&&!this.rebuilding&&(this.inputDisabled=!0)},showPopupMicroworld:function(a){this.setWHMwFront(a),this.displayMicroworld(a,this.microworldContainerFront),this.microworldPopup.removeClass("oculto"),this.microworldPopup.css("z-index",101),this.plastaPopup.removeClass("oculto"),this.plastaPopup.css("z-index",100),this.btClosePopupMW.attr("data-mw",a.config.id)},closePopupMicroworld:function(){this.microworldPopup.addClass("oculto"),this.plastaPopup.addClass("oculto");var a=this.dialogManager.dialog.microworldHolder[this.btClosePopupMW.data("mw")];a.hasBeenClosed||(a.config.toNextQuestionOnClose&&this.dialogManager.dialog.analyzeAnswer(" "),a.hasBeenClosed=!0)},setWHMwFront:function(a){this.microworldPopup.css({width:a.microworldIframe.width(),height:a.microworldIframe.height()})},doMicroworlds:function(a){for(var b=a.getActionsMicroworld("hide"),c=0;c<b.length;c++){var d=b[c],e=this.dialogManager.dialog.microworldHolder[d];e&&(e.isActive=!1,e.config.reset||0==e.config.showLink?e.remove():e.firstLoad||e.hide(),0==e.config.showLink&&$("#link_"+d).remove())}if(a.hasActionMicroworld("display")){var f=a.getActionsMicroworld("display");this.showMicroworld(f),this.createMwLinks(f)}var g=a.getActionsMicroworld("set");for(c=0;c<g.length;c++)if(/[:=]/.test(g[c])){var h=g[c].replace(/:.+/,""),i=g[c].replace(/(^[^:]+:|=.+$)/g,""),j=g[c].replace(/(^[^=]+=)/g,"");"##"==j?j=this.answerText:"###"==j&&(j=this.dialogManager.dialog.matchedLemmas.join());var k={type:"set",name:i,value:j},e=this.dialogManager.dialog.microworldHolder[h];e&&(e.status==IframeMicroworld.READY?e.sendMessage(k):e.readyMessages.push(k))}},createMwLinks:function(a){for(var b,c,d=this,e=0;e<a.length;e++)b=this.dialogManager.dialog.microworldHolder[a[e]],1==b.config.showLink&&0==$("#link_"+a[e]).length&&(c=jQuery('<div id="link_'+a[e]+'" class="linkMicroworld selected" data-mw="'+a[e]+'" title="'+b.config.textLink+'"></div>'),jQuery("<img/>",{src:"img/dialogo/thumbsMicromundos/"+b.config.id+".png","class":"linkMw_img"}).appendTo(c),c.on("click",function(){var a=$(this).attr("data-mw"),b=d.dialogManager.dialog.microworldHolder[a];d.showMwVisited(b)}),$("#historial_micromundos").append(c),d.rebuilding||d.show("#historial_micromundos")),d.deselectLinks(b.config.id)},deselectLinks:function(a){jQuery(".linkMicroworld").each(function(){jQuery(this).attr("id")=="link_"+a?jQuery(this).addClass("selected"):jQuery(this).removeClass("selected")})},showMwVisited:function(a){a.config.front?(this.hideMws(this.microworldContainerFront),this.showPopupMicroworld(a)):(this.hideMws(this.microworldContainer),this.displayMicroworld(a,this.microworldContainer),this.deselectLinks(a.config.id))},hideMws:function(a){for(var b in this.dialogManager.dialog.microworldHolder)a.has('[data-id="'+b+'"]').length>0&&this.dialogManager.dialog.microworldHolder[b].hide()},displayMicroworld:function(a,b){return a.firstLoad?void a.load(b):void a.show()},hideMicroworld:function(){console.log("AvatarDialogUI.hideMicroworld")},destroyMicroworld:function(){console.log("AvatarDialogUI.destroyMicroworld")},addMicroworldLink:function(){console.log("AvatarDialogUI.addMicroworldLink")},pauseChat:function(){this.disableInput()},resumeChat:function(){this.enableInput()},endDialog:function(){if(this.inputDisabled=!0,this.disableInput(),this.inputField.html(""),/^Probador/i.test(this.options.userData.userName)){var a=this.dialogManager.dialog.config.title+this.dialogManager.dialog.config.version+"_respuestas",b=this.dialogManager.dialog._getValueFromLocalStorage(a),b=b.replace(/\|/g," | ");setTimeout(function(){alert("Aquí están todas tus contestaciones. Favor de copiarlas y mandarlas por correo a su contacto en el equipo Diálogos SEP. ¡Muchas gracias! RESPUESTAS: "+b)},4e3)}},disableInput:function(){$("#plastaKeyboard").css("z-index",$("#virtualKeyboardDialog").css("z-index")+1)},enableInput:function(){this.inputDisabled||($("#plastaKeyboard").css("z-index",$("#virtualKeyboardDialog").css("z-index")-1),this.inputField.removeClass("txt_alumno_accepted").addClass("txt_alumno_writing"),
this.eraseInput?this.inputField.html("Escribe tu respuesta y pulsa ACEPTAR."):(jsKeyboard.disableEnter(!1),jsKeyboard.eraseTxtAl=!1))},hide:function(a){$(a).hasClass("oculto")||$(a).addClass("oculto")},show:function(a){$(a).hasClass("oculto")&&$(a).removeClass("oculto")},setRebuilding:function(a){this.rebuilding=a,a||this.finishRebuilding()},finishRebuilding:function(){this.hide(".cargador"),showDialogElements(),this.show("#historial_micromundos"),this.lastMw&&(this.lastMw.isActive=!0)}},_extends(AvatarDialogUITextarea,AvatarDialogUI,{init:function(){this._super.init.apply(this,arguments);var a=this;this.inicio=!0,this.inputField.val(this.options.messages.inputChat),this.inputField.keyup(function(b){a.getUserInterventionText(b)}),this.inputField.focus(function(){a.inicio&&(a.inicio=!1,a.clearContents(this))})},initializeElementsAvatarUI:function(){this.prepareInterventionSound(),this.options.GENDER.WOMAN.regex.test(this.options.userData.userAvatar)?this.options.gender="WOMAN":this.options.gender="MAN",$("#avatar_alumno").attr("src","img/alumno/"+this.options.userData.userAvatar+".png");var a=this;this.chatButton.bind("click",function(){a.showChat()}),this.addCustomScrollbar()},clearContents:function(a){a.value=""},getUserInterventionText:function(a){var b=a.keyCode?a.keyCode:a.charCode;"13"==b&&this.validInput(this.inputField.val())&&(respuesta=this.inputField.val(),this.inputField.val(""),this.showInterventionsStudent(respuesta))},validInput:function(a){var b=!1,c=/[a-z\d]/i;return c.test(a)&&(b=!0),b},disableInput:function(){this.inputDisabled||this.inputField.prop("disabled",!0)},enableInput:function(){this.inputDisabled||(this.inputField.prop("disabled",!1),this.inputField.removeClass("txt_alumno_accepted").addClass("txt_alumno_writing"))}}),DialogManager.DEFAULT_OPTIONS={requirements:{features:["postmessage"]},optionalFeatures:{features:["localstorage","audio","video"],formats:{audio:["mp3"],video:["h264"]}},messages:{notAllRequirements:"Para ver este recurso es necesario usar un navegador de última generación como Firefox, Chrome, Safari o Internet Explorer 10 en adelante."}},DialogManager.prototype={init:function(){return this._verifyRequirements()?(this.dialog.init(),this.ui.init(),this._initEvents(),void this._receiveActions()):(console.log("All requirements not met"),void this.ui.showMessageWindow(this.options.messages.notAllRequirements))},start:function(a){this.dialog.start(a)},_verifyRequirements:function(){for(var a=this.options.requirements,b=a.features,c=0;c<b.length;c++)if(console.log("Verifying "+b[c]+": "+Modernizr[b[c]]),!Modernizr[b[c]])return!1;var d=this.availableFeatures;b=this.options.optionalFeatures.features;for(var c=0;c<b.length;c++)console.log("Verifying (optional)"+b[c]+": "+Modernizr[b[c]]),d[b[c]]=!1,Modernizr[b[c]]&&(d[b[c]]=!0);var e=this.options.optionalFeatures.formats;for(var f in e)for(c=0;c<e[f].length;c++)console.log("Verifying support for: "+f+" : "+e[f][c]+" --> "+Modernizr[f][e[f][c]]),d[f+"_"+e[f][c]]=!1,null!=Modernizr[f][e[f][c]]&&""!=Modernizr[f][e[f][c]]&&(d[f+"_"+e[f][c]]=!0);var g=detect.parse(navigator.userAgent);return console.log("OS: "+g.os.family+", browser: "+g.browser.family),jQuery("html").addClass(g.os.family.toLowerCase()+" "+g.browser.family.toLowerCase()),!0},_initEvents:function(){null!=window.addEventListener&&window.addEventListener("message",jQuery.proxy(this.receiveMessage,this),!1)},_receiveActions:function(){this.addReceiveAction("microWorldReady",function(a,b){var c=a.dialog.microworldHolder[b.id];if(null!=c){if(""!=c.reconstructionData){var d={type:"set",name:"mwReconstruction",value:c.reconstructionData};return c.sendMessage(d),void(c.reconstructionData="")}if(null!=c.readyMessages)for(var e=0;e<c.readyMessages.length;e++)c.sendMessage(c.readyMessages[e]);c.status=IframeMicroworld.READY,c.readyMessages=[]}}),this.addReceiveAction("mwReconstructed",function(a,b){var c=a.dialog.microworldHolder[b.id];if(null!=c){if(null!=c.readyMessages)for(var d=0;d<c.readyMessages.length;d++)c.sendMessage(c.readyMessages[d]);c.status=IframeMicroworld.READY,c.readyMessages=[]}}),this.addReceiveAction("microWorld",function(a,b){a.ui.showMicroworld([b.id])}),this.addReceiveAction("showDefinition",function(a,b){var c=a.dialog.microworldHolder[b.id];null!=c&&c.isActive&&a.ui.showDefinition(b.value.toString())}),this.addReceiveAction("setAnswer",function(a,b){var c=a.dialog.microworldHolder[b.id];"cap1_candidatas"==b.id&&console.log("EN MANAGER ---------> cap1_candidatas.isActive:"+c.isActive),null!=c&&c.isActive&&a.ui.showInterventionsStudent(b.value)}),this.addReceiveAction("gotoNextQuestion",function(a,b){var c=a.dialog.microworldHolder[b.id];null!=c&&c.isActive&&a.dialog.analyzeAnswer(" ")}),this.addReceiveAction("gotoQuestion",function(a,b){a.dialog.setCurrentQuestion(b.value)}),this.addReceiveAction("showTutorIntervention",function(a,b){a.dialog.addIntervention({text:b.text,emotion:b.emotion},Intervention.PROMPT),a.dialog.interventionsReady()}),this.addReceiveAction("disableChat",function(a,b){a.ui.inputDisabled=!0,a.ui.pauseChat()}),this.addReceiveAction("enableChat",function(a,b){a.ui.inputDisabled=!1,a.ui.resumeChat()}),this.addReceiveAction("question",function(a,b){console.log("QUESTION "+b.value)}),this.addReceiveAction("set",function(a,b){console.log("SET "+b.value)}),this.addReceiveAction("update",function(a,b){alert("UPDATE "+b.value)}),this.addReceiveAction("addMicroworldSettings",function(a,b){var c=a.dialog.microworldHolder[b.id];if(null!=c&&c.isActive){var d=b.name+":"+b.value;c.mwSettings.mw.push(d),a.dialog.addMwSettingToLS(b.id,d)}}),this.addReceiveAction("getMicroworldSettings",function(a,b){var c=a.dialog.microworldHolder[b.id],d=a.dialog.microworldHolder[b.targetId];if(null!=c&&null!=d){var e=b.src,f={type:"set",name:"microworldSettings",value:d.mwSettings[e].join()};c.sendMessage(f)}}),this.addReceiveAction("setMicroworldValue",function(a,b){var c=a.dialog.microworldHolder[b.targetId];if(null!=c){var d=b.name,e=b.value,f={type:"set",name:d,value:e};c.sendMessage(f)}}),this.addReceiveAction("getUserAvatar",function(a,b){var c=a.dialog.microworldHolder[b.id],d=a.ui.options.userData.userAvatar;if(null!=c){var e={type:"set",name:"userAvatar",value:d};c.sendMessage(e)}}),this.addReceiveAction("getUserName",function(a,b){var c=a.dialog.microworldHolder[b.id],d=a.ui.options.userData.userName;if(null!=c){var e={type:"set",name:"userName",value:d};c.sendMessage(e)}})},receiveMessage:function(a){a.data&&this.executeAction(a.data.command,a.data.params)},postMessage:function(a,b){var c=this.dialog.microworldHolder[a];null!=c&&c.sendMessage(b)},addReceiveAction:function(a,b){this.windowActions[a]=b},processAnswer:function(a){this.dialog.verifyAnswer(a)},loadQuestion:function(){console.log("DialogManager.loadQuestion")},executeAction:function(a,b){null!=this.windowActions[a]&&this.windowActions[a](this,b)},getUserIntervention:function(){console.log("DialogManager.getUserIntervention")},loadNextQuestion:function(){console.log("DialogManager.loadNextQuestion")}};var abc=new Array("a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","ñ"),conectores=new Array("pero","porque","ya que"),obj=[],regexArr=[{regex:/(n)/g,opciones:["ñ"],lDerecha:0,doble:!1},{regex:/([aá])/g,opciones:["a","á"],lDerecha:0,doble:!1},{regex:/([eé])/g,opciones:["e","é"],lDerecha:0,doble:!1},{regex:/([ií])/g,opciones:["i","í"],lDerecha:0,doble:!1},{regex:/([oó])/g,opciones:["o","ó"],lDerecha:0,doble:!1},{regex:/([uúü])/g,opciones:["u","ú","ü"],lDerecha:0,doble:!1},{regex:/([sz])([aouáóúübcdlmnprt])/g,opciones:["z","s"],lDerecha:1,doble:!1},{regex:/([csz])([eéií])/g,opciones:["z","s","c"],lDerecha:1,doble:!1},{regex:/([sz])$/g,opciones:["z","s"],lDerecha:0,doble:!1},{regex:/([ck])([aáoóuúübclmnrst])/g,opciones:["c","k"],lDerecha:1,doble:!1},{regex:/(k)([eéií])/g,opciones:["k","qu"],lDerecha:1,doble:!1},{regex:/([vb])/g,opciones:["v","b"],lDerecha:0,doble:!1},{regex:/(g)([eéií])/g,opciones:["g","j","gu"],lDerecha:1,doble:!1},{regex:/(j)([eéií])/g,opciones:["g","j"],lDerecha:1,doble:!1},{regex:/(gu)([eéií])/g,opciones:["gu","gü"],lDerecha:1,doble:!0},{regex:/(y)([aáeéiíoóuúü])/g,opciones:["y","ll"],lDerecha:1,doble:!1},{regex:/(ll)([aáeéiíoóuúü])/g,opciones:["y","ll"],lDerecha:1,doble:!0},{regex:/([aáeéiíoóuúü])(r)([aáeéiíoóuúü])/g,opciones:["r","rr"],lDerecha:1,doble:!1},{regex:/([aáeéiíoóuúü])(rr)([aáeéiíoóuúü])/g,opciones:["r","rr"],lDerecha:1,doble:!0},{regex:/^([aá])/g,opciones:["ha","há"],lDerecha:0,doble:!1},{regex:/^([eé])/g,opciones:["he","hé"],lDerecha:0,doble:!1},{regex:/^([ií])/g,opciones:["hi","hí"],lDerecha:0,doble:!1},{regex:/^([oó])/g,opciones:["ho","hó"],lDerecha:0,doble:!1},{regex:/^([uú])/g,opciones:["hu","hú"],lDerecha:0,doble:!1},{regex:/^h([aáeéiíoóuúü])/g,opciones:["","h"],lDerecha:1,doble:!1}],nearKeysArr={a:"qws",b:"vhjn",c:"xfgv",d:"sefzx",e:"wdr",f:"drgxc",g:"fthcv",h:"gyjvb",i:"uko",j:"hukbn",k:"jilmn",l:"koñm",m:"nkl",n:"bjkm","ñ":"lp",o:"ilp",p:"oñl",q:"asw",r:"eft",s:"awdz",t:"rgy",u:"yji",v:"cghb",w:"qse",x:"zdfc",y:"thu",z:"sdx"," ":"zxcvb"};String.prototype.replaceAt=function(a,b){return this.substr(0,a)+b+this.substr(a+b.length)},String.prototype.insertAt=function(a,b){return this.substr(0,a)+b+this.substr(a)},String.prototype.deleteAt=function(a,b){return this.substr(0,a)+this.substr(a+b)},String.prototype.invertirChars=function(a,b){return this.substr(0,a)+this.substr(b,1)+this.substr(a,1)+this.substr(b+1)},String.prototype.replaceArray=function(a,b){for(var c=this,d=0;d<a.length;d++)c=c.replace(a[d],b[d]);return c},Nodo_arbol.prototype.setToken=function(a){this.token=a,this.setType()},Nodo_arbol.prototype.setType=function(){var a=/(\+\+|-\>|&&|\/\/|&\+|\!|#|_)/;"("==this.token?this.type=this.lp:")"==this.token?this.type=this.rp:a.test(this.token)?(this.type=this.op,this.setValor()):this.type=this.pal},Nodo_arbol.prototype.setValor=function(){"#"==this.token?this.valor=0:"!"==this.token?this.valor=1:"&&"==this.token||"&+"==this.token||"_"==this.token?this.valor=2:("//"==this.token||"++"==this.token||"->"==this.token)&&(this.valor=3)},Nodo_arbol.prototype.addChild=function(a){this.children.unshift(a)},Nodo_arbol.prototype.reset=function(){this.match=!1,this.datosPos=[],this.datosPosTmp=[],this.lemasMatched=[],this.esNeg=!1,this.neg=!1},Nodo_arbol.prototype.analizar=function(a){if(this.children.length>1)if(2==a&&this.reset(),"//"==this.token){this.match=!1;for(var b=0;b<this.children.length;b++)this.children[b].analizar(a)&&(this.match=!0)}else{this.match=!0;for(var b=0;b<this.children.length;b++)this.children[b].analizar(a)||(this.match=!1);if("&&"!=this.token&&this.match){for(var c=new Array,b=0;b<this.children.length;b++)c.push(this.children[b].getPos(new Array));switch(this.token){case"++":this.match=this.checarPos(c,"++");break;case"&+":this.match=this.checarPos(c,"&+");break;case"_":this.match=this.checarPos(c,"_");break;case"->":this.match=this.checarPos(c,"++"),this.match&&(this.match=this.checarCausa(c))}}}else if(1==this.children.length)switch(2==a&&this.reset(),this.token){case"!":this.match=!this.children[0].analizar(a);break;case"#":this.match=this.children[0].checkMatch(0)&&this.children[0].negacion(!0),this.match&&(this.children[0].match=!0)}else 1==a?this.match=this.checkMatch(1):2==a&&(0==this.neg?(this.reset(),this.match=this.checkMatch(1)):this.checkPosNeg()?(this.reset(),this.match=this.checkMatch(2)):this.match=!1);return this.match},Nodo_arbol.prototype.checkMatch=function(a){var b=!1,c=this.token.split(",");this.arrLemas=dialogManager.dialog.currentLemmas;for(var d=0;d<this.arrLemas.length;d++)for(var e=0;e<this.arrLemas[d].length;e++)for(var f in this.arrLemas[d][e])for(var g=0;g<c.length;g++)f==c[g]&&(this.lemasMatched.push(f),dialogManager.dialog.matchedLemmas.push(f),this.datosPosTmp.push(new Array(d,e)));return this.lemasMatched.length>0&&(1==a?b=!this.negacion(!1):2==a?(this.datosPos=this.datosPosTmp,b=!0):b=!0),b},Nodo_arbol.prototype.negacion=function(a){for(var b=!1,c=new Array("no","nunca","jamás","jamas","nada","nadie","ningún","ningun","ninguno","ninguna","ni","nul","sin","falta","faltan","faltó","falto","faltaron"),d=new Array("que","quien","donde","cuando","cual","cuales"),e=0;e<this.datosPosTmp.length;e++){for(var f=this.datosPosTmp[e],g=f[0],h=f[1],i=0,j=0,k=!1,l=-1,m=0;h>m;m++){this.arrLemas=dialogManager.dialog.currentLemmas;for(var n in this.arrLemas[g][m]){if(inArray(n,c)){dialogManager.dialog.arrPosNeg.push(new Array(g,m)),k?j++:i++;break}if(inArray(n,d)){k=!0,l=m;break}}}0==k&&i>0||1==k&&(0==i&&j>0||i>0&&0==j)?a&&(b=!0,this.esNeg=!0,dialogManager.dialog.huboNeg=!0,this.datosPos.push(this.datosPosTmp[e])):0==a&&this.datosPos.push(this.datosPosTmp[e])}return 0==a&&0==this.datosPos.length&&(b=!0,this.neg=!0,dialogManager.dialog.huboNegado=!0),b},Nodo_arbol.prototype.checkPosNeg=function(){for(var a=!1,b=0;b<dialogManager.dialog.arrPosNeg.length;b++)for(var c=dialogManager.dialog.arrPosNeg[b],d=0;d<this.datosPosTmp.length;d++){var e=this.datosPosTmp[d];if(c[0]==e[0]&&c[1]<e[1]){a=!0;break}}return a},Nodo_arbol.prototype.getPos=function(a){if(this.match)if(this.children.length>0)for(var b=0;b<this.children.length;b++){var c=this.children[b].getPos(a);c.length>0&&(a=this.compararDatos(a,c))}else a=this.datosPos.length>0?this.getIniFin():new Array;return a},Nodo_arbol.prototype.getIniFin=function(){for(var a=new Array,b=0;b<this.datosPos.length;b++){var c=this.datosPos[b],d=c[0],e=c[1];a.push(d+","+d+","+e+","+e)}return a},Nodo_arbol.prototype.compararDatos=function(a,b){for(var c=new Array,d=0;d<b.length;d++){var e=b[d].split(","),f=e[0],g=e[1],h=e[2],i=e[3];if(0==a.length)c.push(f+","+g+","+h+","+i);else for(var j=0;j<a.length;j++){var k=a[j].split(","),l=k[0],m=k[1],n=k[2],o=k[3];l>f?(l=f,n=h):n>h&&(n=h),g>m?(m=g,o=i):i>o&&(o=i),c.push(l+","+m+","+n+","+o)}}return c},Nodo_arbol.prototype.checarPos=function(a,b){for(var c,d,e,f,g=!0,h=0;h<a.length-1;h++){for(var i=!1,j=a[h],k=a[h+1],l=0;l<j.length;l++){var m=j[l].split(","),n=this.getPosGlobal(m);c=n[0],d=n[1];for(var o=0;o<k.length;o++){var p=k[o].split(","),q=this.getPosGlobal(p);if(e=q[0],f=q[1],"++"==b){if(e>c&&e>d||c>f&&d>f){i=!0;break}}else if("&+"==b){if(e>d){i=!0;break}}else if("_"==b&&c==e-1){i=!0;break}}if(i)break}if(0==i){g=!1;break}}return g},Nodo_arbol.prototype.getPosGlobal=function(a){var b,c,d=0;this.arrLemas=dialogManager.dialog.currentLemmas;for(var e=0;e<this.arrLemas.length;e++)e==a[0]&&(b=d+parseInt(a[2])),e==a[1]&&(c=d+parseInt(a[3])),d+=this.arrLemas[e].length;return new Array(b,c)},Nodo_arbol.prototype.checarCausa=function(a){var b=!1,c=new Array("dado que","ya que","porque","por que","a causa de","debido a","se debe a","se debería a","en vista de","como","si"),d=new Array("dado que","ya que","porque","por que","a causa de","debido a","se debe a","se debería a","en vista de","pues","si"),e=new Array("para","a fin de","con el objeto de"),f=new Array("por eso","por esto","por lo mismo","por lo que","por lo cual","debido a eso","debido a lo que","entonces","caus","para","de modo que","de manera que","así","a fin de");return b=this.checkPosCtrCausa(c,a,"c1"),0==b&&(b=this.checkPosCtrCausa(d,a,"c2")),0==b&&(b=this.checkPosCtrCausa(e,a,"e1")),0==b&&(b=this.checkPosCtrCausa(f,a,"e2")),b},Nodo_arbol.prototype.checkPosCtrCausa=function(a,b,c){for(var d=!1,e="(",f=0;f<a.length;f++){var g=a[f];"("!=e&&(e+="//"),e+="("+g.replace(/ /g,"_")+")"}e+=")";var h=getTokens(e),i=parsear(h),j=i[0];if(d=j[0].analizar(1)){var k=j[0].getPos(new Array);d=this.checarPosCausa(k,b,c)}return d},Nodo_arbol.prototype.checarPosCausa=function(a,b,c){var d=!1;if(2==b.length)for(var e=b[0],f=b[1],g=0;g<a.length;g++){for(var h=a[g].split(","),i=this.getPosGlobal(h),j=i[0],k=i[1],l=0;l<e.length;l++){for(var m=e[l].split(","),n=this.getPosGlobal(m),o=n[0],p=n[1],q=0;q<f.length;q++){var r=f[q].split(","),s=this.getPosGlobal(r),t=s[0],u=s[1];if("c1"==c){if(o>k&&t>p){d=!0;break}}else if("c2"==c){if(j>u&&o>k){d=!0;break}}else if("e1"==c){if(t>k&&o>u){d=!0;break}}else if("e2"==c&&j>p&&t>k){d=!0;break}}if(d)break}if(d)break}else alert("El operador CAU puede unir 2 y sólo 2 expresiones.");return d};